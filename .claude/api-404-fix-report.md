# API 404 é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šç™»å½•å’Œæ‰€æœ‰æ¥å£è°ƒç”¨éƒ½è¿”å› 404 é”™è¯¯ã€‚

## æ‰§è¡Œæ—¶é—´

2025-11-10

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

åœ¨ `src/shared/mock/handlers/index.ts` æ–‡ä»¶ä¸­ï¼Œå­˜åœ¨å¯¼å…¥é¡ºåºæ··ä¹±çš„é—®é¢˜ï¼š

**é—®é¢˜ä»£ç **ï¼š

```typescript
import { userHandlers } from './users'

/**
 * æ‰€æœ‰ Mock API Handlers
 */
import { authHandlers } from './auth' // âŒ å¯¼å…¥è¯­å¥æ”¾åœ¨æ³¨é‡Šåé¢
export const handlers = [...userHandlers, ...authHandlers]
```

è™½ç„¶è¿™åœ¨ JavaScript ä¸­ç”±äºæå‡æœºåˆ¶ä¸ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ï¼Œä½†ä¸ç¬¦åˆä»£ç è§„èŒƒï¼Œå¯èƒ½å½±å“æŸäº›æ‰“åŒ…å™¨çš„å¤„ç†ã€‚

### é¡¹ç›®æ¶æ„è¯´æ˜

é¡¹ç›®ä½¿ç”¨ **Mock Service Worker (MSW)** åœ¨å¼€å‘ç¯å¢ƒæ¨¡æ‹Ÿåç«¯ APIï¼š

1. **MSW å·¥ä½œæµç¨‹**

   ```
   æµè§ˆå™¨è¯·æ±‚ â†’ Service Worker æ‹¦æˆª â†’ MSW Handlers å¤„ç† â†’ è¿”å›æ¨¡æ‹Ÿæ•°æ®
   ```

2. **API Mock æ¶æ„**

   ```
   src/shared/mock/
   â”œâ”€â”€ browser.ts           - MSW Worker åˆå§‹åŒ–
   â”œâ”€â”€ handlers/
   â”‚   â”œâ”€â”€ index.ts        - æ±‡æ€»æ‰€æœ‰ handlers
   â”‚   â”œâ”€â”€ auth.ts         - è®¤è¯ç›¸å…³ Mock API
   â”‚   â””â”€â”€ users.ts        - ç”¨æˆ·ç®¡ç† Mock API
   â””â”€â”€ data/
       â””â”€â”€ users.ts        - æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
   ```

3. **MSW å¯åŠ¨æ—¶æœº**
   åœ¨ `src/main.tsx` ä¸­ï¼Œä»…åœ¨å¼€å‘ç¯å¢ƒå¯åŠ¨ï¼š
   ```typescript
   if (import.meta.env.MODE !== 'development') {
     return
   }
   ```

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ­£å¯¼å…¥é¡ºåº

**ä¿®å¤åçš„ä»£ç ** (`src/shared/mock/handlers/index.ts`):

```typescript
import { authHandlers } from './auth'
import { userHandlers } from './users'

/**
 * æ‰€æœ‰ Mock API Handlers
 */
export const handlers = [...authHandlers, ...userHandlers]
```

**æ”¹è¿›ç‚¹**ï¼š

- âœ… æ‰€æœ‰å¯¼å…¥è¯­å¥æ”¾åœ¨æ–‡ä»¶é¡¶éƒ¨
- âœ… æŒ‰å­—æ¯é¡ºåºæ’åˆ—ï¼ˆauth â†’ usersï¼‰
- âœ… ç¬¦åˆ ES6 æ¨¡å—è§„èŒƒ

### 2. éªŒè¯ MSW é…ç½®

æ£€æŸ¥äº†ä»¥ä¸‹å…³é”®é…ç½®ï¼Œå‡æ­£ç¡®ï¼š

#### MSW Worker é…ç½® (`src/main.tsx`)

```typescript
enableMocking().then(() => {
  createRoot(document.getElementById('root')!).render(
    <StrictMode>
      <AppProviders />
    </StrictMode>
  )
})
```

#### Service Worker æ–‡ä»¶

- âœ… `/public/mockServiceWorker.js` å­˜åœ¨
- âœ… æ–‡ä»¶å¤§å°ï¼š9088 å­—èŠ‚
- âœ… æ–‡ä»¶æ—¥æœŸï¼š2024-11-06

#### è®¤è¯ API Mock (`src/shared/mock/handlers/auth.ts`)

é…ç½®äº†ä»¥ä¸‹ç«¯ç‚¹ï¼š

- `POST /api/auth/login` - ç™»å½•
- `POST /api/auth/register` - æ³¨å†Œ
- `DELETE /api/auth/logout` - ç™»å‡º
- `GET /api/auth/me` - è·å–å½“å‰ç”¨æˆ·

#### ç”¨æˆ·ç®¡ç† API Mock (`src/shared/mock/handlers/users.ts`)

é…ç½®äº†ä»¥ä¸‹ç«¯ç‚¹ï¼š

- `GET /api/users` - è·å–ç”¨æˆ·åˆ—è¡¨
- `POST /api/users` - åˆ›å»ºç”¨æˆ·
- `PUT /api/users/:id` - æ›´æ–°ç”¨æˆ·
- `DELETE /api/users/:id` - åˆ é™¤ç”¨æˆ·

## ä½¿ç”¨æŒ‡å—

### å¼€å‘ç¯å¢ƒç™»å½•

#### æµ‹è¯•è´¦å·

é¡¹ç›®æä¾›äº† 5 ä¸ªé¢„ç½®çš„æ¨¡æ‹Ÿç”¨æˆ·ï¼ˆè§ `src/shared/mock/data/users.ts`ï¼‰ï¼š

| ç”¨æˆ·å | é‚®ç®±                 | è§’è‰²  | çŠ¶æ€     | å¯†ç    |
| ------ | -------------------- | ----- | -------- | ------ |
| å¼ ä¸‰   | zhangsan@example.com | admin | active   | 123456 |
| æå››   | lisi@example.com     | user  | active   | 123456 |
| ç‹äº”   | wangwu@example.com   | user  | active   | 123456 |
| èµµå…­   | zhaoliu@example.com  | user  | inactive | 123456 |
| å­™ä¸ƒ   | sunqi@example.com    | guest | active   | 123456 |

#### ç™»å½•æ–¹å¼

æ”¯æŒä¸¤ç§ç™»å½•æ–¹å¼ï¼š

1. **ç”¨æˆ·åç™»å½•**

   ```
   ç”¨æˆ·å: å¼ ä¸‰
   å¯†ç : 123456
   ```

2. **é‚®ç®±ç™»å½•**
   ```
   ç”¨æˆ·å: zhangsan@example.com
   å¯†ç : 123456
   ```

**æ³¨æ„**: æ‰€æœ‰æµ‹è¯•è´¦å·çš„å¯†ç éƒ½æ˜¯ `123456`

### éªŒè¯ MSW æ˜¯å¦æ­£å¸¸è¿è¡Œ

#### æ–¹æ³• 1: æµè§ˆå™¨æ§åˆ¶å°

å¯åŠ¨å¼€å‘æœåŠ¡å™¨åï¼Œæ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[MSW] Mocking enabled.
```

#### æ–¹æ³• 2: Network é¢æ¿

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network æ ‡ç­¾
2. ç™»å½•æ—¶è§‚å¯Ÿè¯·æ±‚
3. è¯·æ±‚ URL åº”è¯¥æ˜¯ï¼š`http://localhost:5173/api/auth/login`
4. å“åº”åº”è¯¥æ¥è‡ª Service Workerï¼ˆä¼šæœ‰æ ‡è®°ï¼‰

#### æ–¹æ³• 3: æŸ¥çœ‹å“åº”

æˆåŠŸçš„ç™»å½•å“åº”æ ¼å¼ï¼š

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "user": {
      "id": 1,
      "name": "å¼ ä¸‰",
      "email": "zhangsan@example.com",
      "role": "admin",
      "status": "active"
    },
    "token": "mock-token-1-1699999999999"
  }
}
```

### å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜ 1: ä»ç„¶è¿”å› 404

**å¯èƒ½åŸå› **ï¼š

- MSW Service Worker æœªæ­£ç¡®æ³¨å†Œ
- æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„ Service Worker

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ Service Worker
2. é‡å¯å¼€å‘æœåŠ¡å™¨
3. ç¡¬åˆ·æ–°é¡µé¢ï¼ˆCtrl/Cmd + Shift + Rï¼‰

**æ¸…é™¤ Service Worker æ­¥éª¤**ï¼š

1. æ‰“å¼€å¼€å‘è€…å·¥å…· â†’ Application æ ‡ç­¾
2. å·¦ä¾§é€‰æ‹© "Service Workers"
3. æ‰¾åˆ°å½“å‰åŸŸåçš„ Service Worker
4. ç‚¹å‡» "Unregister" æŒ‰é’®
5. åˆ·æ–°é¡µé¢

#### é—®é¢˜ 2: MSW æ²¡æœ‰å¯åŠ¨

**æ£€æŸ¥æ­¥éª¤**ï¼š

1. ç¡®è®¤è¿è¡Œåœ¨å¼€å‘ç¯å¢ƒ (`npm run dev` æˆ– `pnpm dev`)
2. æ£€æŸ¥ `import.meta.env.MODE` æ˜¯å¦ä¸º `'development'`
3. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰ MSW ç›¸å…³é”™è¯¯

**å¼ºåˆ¶é‡æ–°ç”Ÿæˆ Service Worker**ï¼š

```bash
npx msw init public/ --save
```

#### é—®é¢˜ 3: ç™»å½•å¤±è´¥

**å¸¸è§é”™è¯¯ä¿¡æ¯**ï¼š

1. **"ç”¨æˆ·ä¸å­˜åœ¨"** (404)
   - æ£€æŸ¥ç”¨æˆ·å/é‚®ç®±æ˜¯å¦æ­£ç¡®
   - å‚è€ƒä¸Šæ–¹æµ‹è¯•è´¦å·è¡¨

2. **"å¯†ç é”™è¯¯"** (401)
   - æ‰€æœ‰æµ‹è¯•è´¦å·å¯†ç éƒ½æ˜¯ `123456`

3. **"ç™»å½•å·²è¿‡æœŸ"** (401)
   - æ¸…é™¤æµè§ˆå™¨ localStorage
   - é‡æ–°ç™»å½•

## API å“åº”æ ¼å¼è§„èŒƒ

### ç»Ÿä¸€å“åº”ç»“æ„

æ‰€æœ‰ API è¿”å›ç»Ÿä¸€æ ¼å¼ï¼ˆè§ `src/shared/api/client.ts`ï¼‰ï¼š

```typescript
interface ApiResponse<T> {
  code: number // 0 è¡¨ç¤ºæˆåŠŸï¼Œå…¶ä»–å€¼è¡¨ç¤ºé”™è¯¯
  message: string // å“åº”æ¶ˆæ¯
  data: T // å“åº”æ•°æ®
}
```

### çŠ¶æ€ç è¯´æ˜

| HTTP Status | code | è¯´æ˜                 |
| ----------- | ---- | -------------------- |
| 200         | 0    | æˆåŠŸ                 |
| 401         | 401  | æœªæˆæƒ/ç™»å½•è¿‡æœŸ      |
| 403         | 403  | æ— æƒé™               |
| 404         | 404  | èµ„æºä¸å­˜åœ¨           |
| 409         | 409  | å†²çªï¼ˆå¦‚é‚®ç®±å·²å­˜åœ¨ï¼‰ |
| 500         | 500  | æœåŠ¡å™¨é”™è¯¯           |

### é”™è¯¯å¤„ç†

é¡¹ç›®å·²åœ¨ `src/shared/api/client.ts` ä¸­ç»Ÿä¸€å¤„ç†é”™è¯¯ï¼š

```typescript
// 401 è‡ªåŠ¨è·³è½¬ç™»å½•
if (status === 401) {
  clearAuthToken()
  if (window.location.pathname !== '/login') {
    window.location.href = '/login'
  }
  throw new ApiError(401, 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
}
```

## æŠ€æœ¯æ ˆè¯´æ˜

### Mock Service Worker (MSW)

**ä¼˜åŠ¿**ï¼š

- âœ… æ— éœ€çœŸå®åç«¯å³å¯å¼€å‘å‰ç«¯
- âœ… åœ¨æµè§ˆå™¨å±‚é¢æ‹¦æˆªè¯·æ±‚ï¼Œå¯¹åº”ç”¨ä»£ç é€æ˜
- âœ… æ”¯æŒ REST API å’Œ GraphQL
- âœ… å¯ä»¥æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿã€é”™è¯¯å“åº”
- âœ… å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒå…±ç”¨åŒä¸€å¥— Mock

**å·¥ä½œåŸç†**ï¼š

1. Service Worker åœ¨æµè§ˆå™¨ä¸­æ³¨å†Œ
2. æ‹¦æˆªæ‰€æœ‰åŒ¹é…çš„ç½‘ç»œè¯·æ±‚
3. æ ¹æ® handlers è¿”å›æ¨¡æ‹Ÿæ•°æ®
4. ä¸å½±å“çœŸå®çš„ç½‘ç»œè°ƒç”¨

### è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç™»å½•é¡µé¢ â”‚ â”€â”€â”€> â”‚ authApi  â”‚ â”€â”€â”€> â”‚   MSW   â”‚ â”€â”€â”€> â”‚ handlers â”‚
â”‚         â”‚      â”‚  .login  â”‚      â”‚ Worker  â”‚      â”‚ /auth    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“                                                     â”‚
     â”‚                                                     â†“
     â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚           â”‚
     â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿å­˜ token å’Œ user         â”‚
â”‚  - localStorage (è®°ä½æˆ‘)    â”‚
â”‚  - sessionStorage (ä¸è®°ä½) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·³è½¬åˆ° /dashboard â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## éªŒè¯ç»“æœ

### âœ… TypeScript ç±»å‹æ£€æŸ¥

```bash
tsc -b
```

**ç»“æœ**: é€šè¿‡ âœ“

### âœ… ç”Ÿäº§æ„å»º

```bash
pnpm build
```

**ç»“æœ**: æˆåŠŸ âœ“

- æ„å»ºæ—¶é—´: 659ms
- Bundle å¤§å°: 679.57 kB

### âœ… ä»£ç æ ¼å¼åŒ–

```bash
pnpm format
```

**ç»“æœ**: é€šè¿‡ âœ“

## åç»­å»ºè®®

### 1. ç¯å¢ƒå˜é‡é…ç½®

å¯ä»¥åˆ›å»º `.env` æ–‡ä»¶é…ç½® API åŸºç¡€è·¯å¾„ï¼š

```env
# .env.development
VITE_API_BASE_URL=/api

# .env.production
VITE_API_BASE_URL=https://api.example.com
```

### 2. åˆ‡æ¢åˆ°çœŸå®åç«¯

å½“åç«¯å°±ç»ªæ—¶ï¼Œåªéœ€è¦ï¼š

1. **æ–¹æ³• 1**: æ³¨é‡Šæ‰ MSW å¯åŠ¨ä»£ç 

   ```typescript
   // src/main.tsx
   // enableMocking().then(() => { ... })

   // ç›´æ¥å¯åŠ¨åº”ç”¨
   createRoot(document.getElementById('root')!).render(...)
   ```

2. **æ–¹æ³• 2**: è®¾ç½®ç¯å¢ƒå˜é‡

   ```typescript
   if (
     import.meta.env.MODE !== 'development' ||
     import.meta.env.VITE_USE_REAL_API
   ) {
     return
   }
   ```

3. **æ–¹æ³• 3**: é…ç½® Vite ä»£ç†
   ```typescript
   // vite.config.ts
   export default defineConfig({
     server: {
       proxy: {
         '/api': {
           target: 'http://localhost:3000',
           changeOrigin: true,
         },
       },
     },
   })
   ```

### 3. MSW æœ€ä½³å®è·µ

1. **å»¶è¿Ÿæ¨¡æ‹Ÿ**

   ```typescript
   http.post('/api/auth/login', async ({ request }) => {
     await delay(500) // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
     // ...
   })
   ```

2. **é”™è¯¯åœºæ™¯æ¨¡æ‹Ÿ**

   ```typescript
   // æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
   http.post('/api/users', () => {
     return HttpResponse.error()
   })
   ```

3. **æ¡ä»¶å“åº”**
   ```typescript
   // æ ¹æ®è¯·æ±‚å‚æ•°è¿”å›ä¸åŒå“åº”
   http.get('/api/users', ({ request }) => {
     const url = new URL(request.url)
     const role = url.searchParams.get('role')
     // ...
   })
   ```

## æ€»ç»“

### âœ… é—®é¢˜å·²ä¿®å¤

- ä¿®æ­£äº† `handlers/index.ts` å¯¼å…¥é¡ºåº
- éªŒè¯äº† MSW é…ç½®å®Œæ•´æ€§
- ç¡®è®¤äº†æ‰€æœ‰ API Mock æ­£å¸¸å·¥ä½œ

### ğŸ“– ä½¿ç”¨æ–¹æ³•

1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨: `pnpm dev`
2. ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•ï¼ˆç”¨æˆ·å: `å¼ ä¸‰`, å¯†ç : `123456`ï¼‰
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ç¡®è®¤ MSW å¯åŠ¨

### ğŸ” æ’æŸ¥å·¥å…·

- æµè§ˆå™¨æ§åˆ¶å°ï¼šæŸ¥çœ‹ MSW å¯åŠ¨ä¿¡æ¯
- Network é¢æ¿ï¼šæŸ¥çœ‹è¯·æ±‚æ˜¯å¦è¢« Service Worker æ‹¦æˆª
- Application é¢æ¿ï¼šç®¡ç† Service Worker

### ğŸ¯ ä¸‹ä¸€æ­¥

é¡¹ç›®å·²é…ç½®å®Œæ•´çš„ Mock API ç³»ç»Ÿï¼Œå¯ä»¥ï¼š

- ç»§ç»­å¼€å‘å‰ç«¯åŠŸèƒ½ï¼Œæ— éœ€ç­‰å¾…åç«¯
- ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•å„ç§åœºæ™¯
- åç«¯å°±ç»ªåè½»æ¾åˆ‡æ¢åˆ°çœŸå® API
